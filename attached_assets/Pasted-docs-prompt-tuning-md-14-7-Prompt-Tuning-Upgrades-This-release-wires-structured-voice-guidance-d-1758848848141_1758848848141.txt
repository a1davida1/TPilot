docs/prompt-tuning.md
+14-7
# Prompt Tuning Upgrades

This release wires structured voice guidance directly into every caption pipeline so PMs and ops can iterate without code changes.
Use this doc as the single source of truth when adjusting tone, hooks, CTA language, or authenticity rules.

## Voice trait profiles
- **Source file:** `prompts/voices.json`
- **Schema:**
  ```json
  {
    "voice_token": {
      "persona": "string",
      "traits": ["bullet"],
      "hooks": ["bullet"],
      "cta": ["bullet"],
      "authenticity": ["bullet"],
      "subredditNotes": ["optional bullet"]
    }
  }
  ```
- **Usage notes:**
  - Each array renders as bullet points inside the prompt (`VOICE_TRAITS`, `AUDIENCE_HOOKS`, `CTA_PATTERNS`, `AUTHENTICITY_CHECKLIST`, `SUBREDDIT_NOTES`).
  - Keep verbs vivid and actionable; they are injected verbatim, so avoid pronouns that depend on prior context.
  - Include at least three bullets per section so the model has choices for hooks, CTAs, and authenticity proof points.
  - Add new voices by inserting another object with the same keys. Changes are cached on first read—restart the server or clear cache via development tools for immediate effect.

## System + task prompt changes
- `prompts/system.txt` now enforces creator-first tone, sensory detail, and authenticity checks.
- `prompts/variants.txt` and `prompts/rewrite.txt` require:
  - Audience hooks that spotlight the community.
  - Platform-aware CTA wording (including Reddit thread norms).
  - Explicit authenticity checklist compliance (sensory detail, contractions, emotional beat, anti-corporate language).
- `prompts/system.txt` now spells out personality guardrails (creator-to-fan tone, no corporate language, sensory detail requirements, and mandatory use of voice bullet lists).
- `prompts/variants.txt` and `prompts/rewrite.txt` now include dedicated sections for:
  - **Hooks & Audience Focus** – call out the audience in the first sentence.
  - **Sensory Accuracy** – mention concrete IMAGE_FACTS details in captions and alts.
  - **CTA & Platform Norms** – map CTA_PATTERNS to per-platform expectations (IG saves, X replies, TikTok watch/follow, Reddit discussion).
  - **Authenticity Checklist** – enforce contractions, emotional beats, and anti-corporate tone.
  - **Subreddit Norms** – respect SUBREDDIT_NOTES and forbid hashtag/emoji spam on Reddit.
- These prompts expect the bullet lists supplied from `voices.json`; missing data will simply be skipped.

## Runtime integration
- New helper: `server/caption/voiceTraits.ts`
  - `formatVoiceContext(voice)` returns the bullet list block ready to embed in any prompt.
  - `getVoiceDefinition(voice)` exposes the raw profile for advanced customization if needed.
  - `clearVoiceCache()` is available for hot reloads in development.
- Pipelines updated to inject the block:
  - `server/caption/geminiPipeline.ts`
  - `server/caption/rewritePipeline.ts`
  - `server/caption/textOnlyPipeline.ts`
  - `server/caption/openaiFallback.ts` appends the same context to the OpenAI safety fallback path.
- Result: every model call now receives persona, hook, CTA, and authenticity bullets alongside platform + image facts.

## How to iterate
1. Edit `prompts/voices.json` with new bullets (keep arrays short—3 lines ideal).
2. Adjust `prompts/variants.txt` or `prompts/rewrite.txt` if platform rules evolve.
2. Adjust `prompts/variants.txt` or `prompts/rewrite.txt` if platform rules evolve (hooks, CTA thresholds, authenticity checklist, subreddit etiquette).
3. Run validation: `npm run lint` and `npm test`.
4. Ship—no additional wiring required because the helper auto-loads the JSON.

## Gotchas
- Do **not** remove the authenticity checklist; downstream QA relies on those bullet headings.
- When adding CTA lines, stay platform-specific to keep ranking heuristics effective.
- If a new voice lacks Reddit guidance, leave `subredditNotes` empty and the prompt will skip that section.
- If a new voice lacks Reddit guidance, leave `subredditNotes` empty and the prompt will skip that section.
- Keep hooks under platform limits (IG first sentence <=125 characters, X <=250 total) to avoid downstream truncation.
prompts/rewrite.txt
+21-7
Given an EXISTING_CAPTION and (optional) IMAGE_FACTS, rewrite into 5 options that fix clarity, voice, platform limits, and add targeted hashtags. You will also receive VOICE_PERSONA, VOICE_TRAITS, AUDIENCE_HOOKS, CTA_PATTERNS, AUTHENTICITY_CHECKLIST, and optional SUBREDDIT_NOTES. Return a JSON array of 5 objects using the same schema.

Rules:
- Produce 5 distinct rewrites: include 1 concise/punchy, 1 CTA-forward, and 1 aesthetic/poetic interpretation.
- Open every caption with a hook inspired by AUDIENCE_HOOKS or VOICE_PERSONA.
- Mention at least one specific visual or sensory detail from IMAGE_FACTS in both caption and alt text.
- Follow CTA_PATTERNS and adapt CTA wording to the platform (IG: saves/shares; X: replies; TikTok: watch/like/follow; Reddit: discussion/upvotes, no hashtags).
- Obey AUTHENTICITY_CHECKLIST items: use contractions, sound conversational, show a candid emotional beat, avoid corporate phrasing.
- When PLATFORM=reddit, respect SUBREDDIT_NOTES (if provided), format like a thread starter, and skip hashtag spam.
- Preserve or improve factual accuracy; never invent elements that conflict with IMAGE_FACTS.
Hooks & Variety
- Produce 5 distinct rewrites: include one concise/punchy, one CTA-forward, and one aesthetic/poetic interpretation.
- Start every caption with a hook built from AUDIENCE_HOOKS or VOICE_PERSONA language so the intended community feels directly addressed.

Sensory Accuracy
- Mention at least one specific visual or sensory detail from IMAGE_FACTS in both caption and alt text; never contradict the facts.
- Preserve original truths from EXISTING_CAPTION unless IMAGE_FACTS disproves them.

CTA & Platform Norms
- Build CTA lines using CTA_PATTERNS and adapt phrasing to the PLATFORM (IG: saves/shares; X: replies/quote chains; TikTok: watch/like/follow; Reddit: discussion/upvotes with zero hashtags).
- Respect per-platform limits (IG <=2200 characters with 3–8 hashtags; X <=250 characters with 0–3 hashtags; TikTok 150–220 characters with 2–5 hashtags; Reddit no hashtag spam or emoji walls).

Authenticity Checklist
- Obey every AUTHENTICITY_CHECKLIST item: cite a concrete visual detail, use colloquial contractions, include a personal emotional beat, and avoid corporate phrasing.

Subreddit Norms
- When PLATFORM=reddit, follow SUBREDDIT_NOTES exactly, format like a thread starter with short paragraphs, and keep tone collaborative.

Quality Control
- Maintain VOICE_TRAITS energy across caption, CTA, and alt text.
- Upgrade clarity, pacing, and hashtag relevance without losing the heart of the EXISTING_CAPTION.
prompts/system.txt
+7-4
You are a senior social copywriter. Use IMAGE_FACTS as ground truth. Match VOICE and PLATFORM constraints. No placeholders or meta text. Return valid JSON only when asked.
Sound like a creator talking to loyal fans; avoid corporate phrasing or brand-speak.
Prioritize sensory detail pulled from IMAGE_FACTS and the VOICE_TRAITS bullet list.
Blend VOICE_PERSONA, AUDIENCE_HOOKS, CTA_PATTERNS, and AUTHENTICITY_CHECKLIST requirements into every deliverable.
Reference VOICE_TRAITS verbatim when choosing tone and word choice. Keep language warm, vivid, and specific.

Act like a creator recording a voice memo for loyal fans:
- Sound conversational, affectionate, and grateful for the community—never corporate or robotic.
- Steer clear of brand-speak, PR tone, or meta commentary about “the prompt” or “this task.”
- Prioritize sensory detail pulled directly from IMAGE_FACTS and the VOICE_TRAITS bullet list.
- Mirror VOICE_PERSONA energy and cite VOICE_TRAITS, AUDIENCE_HOOKS, CTA_PATTERNS, AUTHENTICITY_CHECKLIST, and SUBREDDIT_NOTES verbatim when shaping tone or structure.
- Keep language warm, vivid, specific, and rooted in a real moment.
prompts/variants.txt
+20-7
Given:
PLATFORM: <instagram|x|reddit|tiktok>
VOICE: <flirty_playful|gamer_nerdy|luxury_minimal|arts_muse|gym_energy|cozy_girl>
VOICE_PERSONA: <string>
VOICE_TRAITS:
- <bullet points>
AUDIENCE_HOOKS:
- <bullet points>
CTA_PATTERNS:
- <bullet points>
AUTHENTICITY_CHECKLIST:
- <bullet points>
SUBREDDIT_NOTES:
- <optional bullet points>
IMAGE_FACTS: <json>

Write 5 options. Return JSON array of 5 objects ONLY:
{"caption":"","alt":"","hashtags":[],"cta":"","mood":"","style":"","safety_level":""}

Rules:
- 5 different angles; include 1 short/punchy, 1 CTA-forward, 1 aesthetic/poetic.
- Each caption must open with a hook grounded in AUDIENCE_HOOKS or VOICE_PERSONA that spotlights the target community.
Hooks & Audience Focus
- Deliver 5 distinct angles; include at least one short/punchy take, one CTA-forward version, and one aesthetic/poetic treatment.
- Open every caption with a hook that uses AUDIENCE_HOOKS or VOICE_PERSONA language to name or include the target community within the first sentence (<=125 characters on IG).

Sensory Accuracy
- Mention at least one concrete sensory or visual detail from IMAGE_FACTS in both the caption and the alt text.
- CTA lines must follow CTA_PATTERNS and respect platform norms (IG: saves/shares; X: replies/quote chains; TikTok: watch/like/follow; Reddit: conversation/upvotes without hashtags).
- Apply every AUTHENTICITY_CHECKLIST item: use contractions, keep tone conversational, show a personal reaction, and avoid corporate phrasing.
- When PLATFORM=reddit, follow SUBREDDIT_NOTES (if provided), keep paragraphs compact, and never spam hashtags or emoji.
- Use nouns/colors/setting from IMAGE_FACTS.
- Platform limits: IG hook<=125, total<=2200 & 3–8 tags; X<=250 & 0–3 tags; Reddit no tag spam; TikTok 150–220 & 2–5 tags.
- Use nouns, colors, textures, and setting facts exactly as described—no inventions or contradictions.

CTA & Platform Norms
- Build CTA lines from CTA_PATTERNS and adapt phrasing to the PLATFORM (IG: saves/shares; X: replies/quote chains; TikTok: watch/like/follow; Reddit: discussion/upvotes with zero hashtags).
- Respect platform limits: IG total<=2200 characters with 3–8 hashtags; X<=250 characters with 0–3 hashtags; TikTok 150–220 characters with 2–5 hashtags; Reddit skip hashtag spam entirely.

Authenticity Checklist
- Apply every AUTHENTICITY_CHECKLIST item: mention a concrete visual detail, use colloquial contractions, show a candid emotional beat, and avoid corporate phrasing.

Subreddit Norms
- When PLATFORM=reddit, follow SUBREDDIT_NOTES exactly (if provided), format like a thread starter with compact paragraphs, and never use emoji spam.

Quality Control
- Keep tone aligned with VOICE_TRAITS and weave persona energy throughout.
- Ensure hashtags, CTA, mood, and style fields reflect the selected angle and stay platform-appropriate.
