> rest-express@1.0.0 test
> vitest run

 DEPRECATED  "environmentMatchGlobs" is deprecated. Use `test.projects` to define different configurations instead.

 RUN  v3.2.4 /home/runner/workspace

stdout | tests/integration/content-generation.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ“¡ auto-backup env with Radar: https://dotenvx.com/radar

stdout | tests/unit/auth/email-verification-redirect.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

stdout | tests/unit/policy-linter.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/unit/auth/email-verification-redirect.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/content-generation.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

stdout | tests/unit/auth/email-verification-redirect.test.ts > Email Verification Redirect Tests > should return JSON success response on valid token in test environment
2025-09-17T14:46:08.937Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"valid-to...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification-redirect.test.ts > Email Verification Redirect Tests > should return JSON success response on valid token in test environment
2025-09-17T14:46:08.941Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"testuser","email":"te***@example.com","responseMode":"JSON"}

 â¯ tests/unit/policy-linter.test.ts (9 tests | 7 failed) 640ms
   Ã— Policy Linter > Blocked Content > blocks content with banned words 52ms
     â†’ expected [ 'Contains banned terms', â€¦(1) ] to include StringContaining "Contains banned terms"
   Ã— Policy Linter > Blocked Content > blocks content matching title regex patterns 39ms
     â†’ expected [ Array(2) ] to include StringContaining{â€¦}
   Ã— Policy Linter > Blocked Content > blocks content with prohibited links 39ms
     â†’ expected [ â€¦(2) ] to include StringContaining{â€¦}
   Ã— Policy Linter > Blocked Content > blocks content exceeding length limits 38ms
     â†’ expected [ 'Missing required tags', 'too long' ] to include StringContaining "too long"
   Ã— Policy Linter > Warning Content > warns on missing required tags 44ms
     â†’ expected [ 'Missing required tags' ] to include StringContaining "Missing required tags"
   Ã— Policy Linter > Warning Content > warns on short content 37ms
     â†’ expected [ Array(2) ] to include StringContaining "too short"
   âœ“ Policy Linter > Clean Content > approves clean content with required tags 36ms
   Ã— Policy Linter > Clean Content > handles unknown subreddits with default rules 44ms
     â†’ expected 'block' to be 'ok' // Object.is equality
   âœ“ Policy Linter > Error Handling > gracefully handles database errors 38ms
stdout | tests/unit/auth/email-verification-redirect.test.ts > Email Verification Redirect Tests > should return JSON error for invalid token (no redirect)
2025-09-17T14:46:08.971Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"invalid-...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification-redirect.test.ts > Email Verification Redirect Tests > should return JSON error for invalid token (no redirect)
2025-09-17T14:46:08.971Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"invalid-..."}

 â¯ tests/unit/auth/email-verification-redirect.test.ts (2 tests | 1 failed) 61ms
   Ã— Email Verification Redirect Tests > should return JSON success response on valid token in test environment 42ms
     â†’ expected "spy" to be called with arguments: [ 'test@example.com', 'testuser' ]

Number of calls: 0

   âœ“ Email Verification Redirect Tests > should return JSON error for invalid token (no redirect) 17ms
stdout | tests/unit/expenses/expense-operations.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/unit/image-generator/ai-service.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use primary AI provider when available
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.286Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use primary AI provider when available
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:09.294Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use primary AI provider when available
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.295Z"}

 â¯ tests/unit/image-generator/ai-service.test.ts (12 tests | 6 failed) 24ms
   Ã— AI Service Unit Tests > Environment Variable Handling > should handle missing OPENAI_API_KEY gracefully 9ms
     â†’ All AI providers failed
   âœ“ AI Service Unit Tests > Environment Variable Handling > should handle missing GOOGLE_GENAI_API_KEY gracefully 2ms
   âœ“ AI Service Unit Tests > Environment Variable Handling > should handle all API keys missing 2ms
   Ã— AI Service Unit Tests > AI Provider Fallback Logic > should fallback from Gemini to OpenAI on quota error 3ms
     â†’ expected "spy" to be called at least once
   Ã— AI Service Unit Tests > AI Provider Fallback Logic > should fallback through all providers on consecutive failures 1ms
     â†’ expected "spy" to be called at least once
   âœ“ AI Service Unit Tests > Error Handling Edge Cases > should handle malformed JSON responses 0ms
   âœ“ AI Service Unit Tests > Error Handling Edge Cases > should handle network timeout errors 1ms
   âœ“ AI Service Unit Tests > Error Handling Edge Cases > should handle rate limit errors with exponential backoff simulation 0ms
   Ã— AI Service Unit Tests > Cost Optimization > should prioritize cheapest provider (Gemini) when available 1ms
     â†’ All AI providers failed
   âœ“ AI Service Unit Tests > Cost Optimization > should track and report estimated costs accurately 1ms
   Ã— AI Service Unit Tests > Platform-Specific Optimizations > should generate Instagram-optimized content 1ms
     â†’ All AI providers failed
   Ã— AI Service Unit Tests > Platform-Specific Optimizations > should generate Reddit-appropriate content without hashtags 1ms
     â†’ All AI providers failed
stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should fallback to secondary provider on primary failure
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.496Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should fallback to secondary provider on primary failure
warn: Gemini generation failed {"error":"Gemini API unavailable","timestamp":"2025-09-17T14:46:09.496Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should fallback to secondary provider on primary failure
warn: AI provider returned empty result {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.497Z"}
info: AI provider attempt {"inputCost":0.8,"provider":"claude-haiku","timestamp":"2025-09-17T14:46:09.497Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should fallback to secondary provider on primary failure
warn: AI provider failed, trying next {"error":"Claude API unavailable","provider":"claude-haiku","timestamp":"2025-09-17T14:46:09.498Z"}
info: AI provider attempt {"inputCost":5,"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:09.498Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should fallback to secondary provider on primary failure
info: AI generation successful {"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:09.498Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.671Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail
warn: Gemini generation failed {"error":"Gemini unavailable","timestamp":"2025-09-17T14:46:09.672Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail
warn: AI provider returned empty result {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.672Z"}
info: AI provider attempt {"inputCost":0.8,"provider":"claude-haiku","timestamp":"2025-09-17T14:46:09.673Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail
warn: AI provider failed, trying next {"error":"Claude unavailable","provider":"claude-haiku","timestamp":"2025-09-17T14:46:09.673Z"}
info: AI provider attempt {"inputCost":5,"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:09.673Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail
warn: AI provider failed, trying next {"error":"OpenAI unavailable","provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:09.674Z"}
error: All AI providers failed - no fallback available {"timestamp":"2025-09-17T14:46:09.674Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail
error: Caption generation failed in test {"error":"All AI providers failed","timestamp":"2025-09-17T14:46:09.675Z"}

stdout | tests/unit/expenses/expense-categories.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ“¡ observe env with Radar: https://dotenvx.com/radar

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Content Generation Flow > should generate platform-specific content
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.858Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Content Generation Flow > should generate platform-specific content
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:09.867Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Content Generation Flow > should generate platform-specific content
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:09.868Z"}

stdout | tests/unit/expenses/expense-operations.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: ðŸ“¡ auto-backup env with Radar: https://dotenvx.com/radar

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > createExpense > should handle expense creation error
Error creating expense: { error: "Cannot read properties of undefined (reading 'values')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > createExpense > should create expense with optional fields
Error creating expense: { error: "Cannot read properties of undefined (reading 'values')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > deleteExpense > should delete expense with valid ID and userId
Error deleting expense: { error: "Cannot read properties of undefined (reading 'where')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > deleteExpense > should handle deletion error
Error deleting expense: { error: "Cannot read properties of undefined (reading 'where')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > deleteExpense > should only delete expense owned by user
Error deleting expense: { error: "Cannot read properties of undefined (reading 'where')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should calculate expense totals correctly
Error getting expense totals: { error: "Cannot read properties of undefined (reading 'name')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should handle empty expense list
Error getting expense totals: { error: "Cannot read properties of undefined (reading 'name')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should filter by tax year when specified
Error getting expense totals: { error: "Cannot read properties of undefined (reading 'name')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should handle partial deduction percentages
Error getting expense totals: { error: "Cannot read properties of undefined (reading 'name')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should handle database error in totals calculation
Error getting expense totals: { error: "Cannot read properties of undefined (reading 'name')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > updateExpense > should update expense with receipt information
Error updating expense: { error: "Cannot read properties of undefined (reading 'set')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > updateExpense > should update expense amount
Error updating expense: { error: "Cannot read properties of undefined (reading 'set')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > updateExpense > should handle update error
Error updating expense: { error: "Cannot read properties of undefined (reading 'set')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getUserExpenses > should fetch user expenses with category information
Error getting user expenses: { error: "Cannot read properties of undefined (reading 'from')" }

stderr | tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getUserExpenses > should fetch expenses without tax year filter
Error getting user expenses: { error: "Cannot read properties of undefined (reading 'from')" }

 â¯ tests/unit/expenses/expense-operations.test.ts (16 tests | 15 failed) 45ms
   Ã— Expense Operations Unit Tests > createExpense > should create expense with valid data 11ms
     â†’ expected "spy" to be called with arguments: [ Anything ]

Received: 

  1st spy call:

  [
-   Anything,
+   undefined,
  ]


Number of calls: 1

   Ã— Expense Operations Unit Tests > createExpense > should handle expense creation error 9ms
     â†’ expected [Function] to throw error including 'Database error' but got 'Cannot read properties of undefined (â€¦'
   Ã— Expense Operations Unit Tests > createExpense > should create expense with optional fields 4ms
     â†’ Cannot read properties of undefined (reading 'values')
   Ã— Expense Operations Unit Tests > deleteExpense > should delete expense with valid ID and userId 1ms
     â†’ Cannot read properties of undefined (reading 'where')
   Ã— Expense Operations Unit Tests > deleteExpense > should handle deletion error 1ms
     â†’ expected [Function] to throw error including 'Expense not found' but got 'Cannot read properties of undefined (â€¦'
   Ã— Expense Operations Unit Tests > deleteExpense > should only delete expense owned by user 1ms
     â†’ Cannot read properties of undefined (reading 'where')
   Ã— Expense Operations Unit Tests > getExpenseTotals > should calculate expense totals correctly 3ms
     â†’ expected { total: +0, deductible: +0, â€¦(1) } to deeply equal { total: 85000, â€¦(2) }
   âœ“ Expense Operations Unit Tests > getExpenseTotals > should handle empty expense list 1ms
   Ã— Expense Operations Unit Tests > getExpenseTotals > should filter by tax year when specified 2ms
     â†’ expected +0 to be 5000 // Object.is equality
   Ã— Expense Operations Unit Tests > getExpenseTotals > should handle partial deduction percentages 2ms
     â†’ expected { total: +0, deductible: +0, â€¦(1) } to deeply equal { total: 50000, â€¦(2) }
   Ã— Expense Operations Unit Tests > getExpenseTotals > should handle database error in totals calculation 2ms
     â†’ promise resolved "{ total: +0, deductible: +0, â€¦(1) }" instead of rejecting
   Ã— Expense Operations Unit Tests > updateExpense > should update expense with receipt information 1ms
     â†’ Cannot read properties of undefined (reading 'set')
   Ã— Expense Operations Unit Tests > updateExpense > should update expense amount 1ms
     â†’ Cannot read properties of undefined (reading 'set')
   Ã— Expense Operations Unit Tests > updateExpense > should handle update error 1ms
     â†’ expected [Function] to throw error including 'Update failed' but got 'Cannot read properties of undefined (â€¦'
   Ã— Expense Operations Unit Tests > getUserExpenses > should fetch user expenses with category information 1ms
     â†’ expected "spy" to be called at least once
   Ã— Expense Operations Unit Tests > getUserExpenses > should fetch expenses without tax year filter 2ms
     â†’ expected [] to deeply equal [ â€¦(2) ]
stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Content Generation Flow > should save generation history
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.249Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Content Generation Flow > should save generation history
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:10.254Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Content Generation Flow > should save generation history
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.254Z"}

stdout | tests/integration/upload.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/unit/expenses/expense-categories.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > createExpenseCategory > should handle category creation error
Error creating expense category: { error: 'Duplicate category name' }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategories > should fetch all active expense categories
Error getting expense categories: { error: "Cannot read properties of undefined (reading 'isActive')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategories > should handle empty categories list
Error getting expense categories: { error: "Cannot read properties of undefined (reading 'isActive')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategories > should handle database error
Error getting expense categories: { error: "Cannot read properties of undefined (reading 'isActive')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > updateExpenseCategory > should update category successfully
Error updating expense category: { error: "Cannot read properties of undefined (reading 'id')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > updateExpenseCategory > should handle update error
Error updating expense category: { error: "Cannot read properties of undefined (reading 'id')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > deleteExpenseCategory > should soft delete category (set isActive to false)
Error deleting expense category: { error: "Cannot read properties of undefined (reading 'id')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > deleteExpenseCategory > should handle deletion error
Error deleting expense category: { error: "Cannot read properties of undefined (reading 'id')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategory > should fetch single category by ID
Error getting expense category: { error: "Cannot read properties of undefined (reading 'id')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategory > should return undefined for non-existent category
Error getting expense category: { error: "Cannot read properties of undefined (reading 'id')" }

stderr | tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategory > should handle database error
Error getting expense category: { error: "Cannot read properties of undefined (reading 'id')" }

 â¯ tests/unit/expenses/expense-categories.test.ts (12 tests | 6 failed) 26ms
   âœ“ Expense Categories Unit Tests > createExpenseCategory > should create expense category with valid data 4ms
   âœ“ Expense Categories Unit Tests > createExpenseCategory > should handle category creation error 4ms
   Ã— Expense Categories Unit Tests > getExpenseCategories > should fetch all active expense categories 4ms
     â†’ expected "spy" to be called at least once
   âœ“ Expense Categories Unit Tests > getExpenseCategories > should handle empty categories list 1ms
   âœ“ Expense Categories Unit Tests > getExpenseCategories > should handle database error 1ms
   Ã— Expense Categories Unit Tests > updateExpenseCategory > should update category successfully 3ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Expense Categories Unit Tests > updateExpenseCategory > should handle update error 4ms
     â†’ expected [Function] to throw error including 'Category not found' but got 'Cannot read properties of undefined (â€¦'
   Ã— Expense Categories Unit Tests > deleteExpenseCategory > should soft delete category (set isActive to false) 1ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Expense Categories Unit Tests > deleteExpenseCategory > should handle deletion error 1ms
     â†’ expected [Function] to throw error including 'Category not found' but got 'Cannot read properties of undefined (â€¦'
   Ã— Expense Categories Unit Tests > getExpenseCategory > should fetch single category by ID 1ms
     â†’ expected "spy" to be called at least once
   âœ“ Expense Categories Unit Tests > getExpenseCategory > should return undefined for non-existent category 1ms
   âœ“ Expense Categories Unit Tests > getExpenseCategory > should handle database error 0ms
stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.623Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
warn: Gemini provider returned empty response {"timestamp":"2025-09-17T14:46:10.627Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
warn: AI provider returned empty result {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.627Z"}
info: AI provider attempt {"inputCost":0.8,"provider":"claude-haiku","timestamp":"2025-09-17T14:46:10.628Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'content')","provider":"claude-haiku","timestamp":"2025-09-17T14:46:10.628Z"}
info: AI provider attempt {"inputCost":5,"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:10.628Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'choices')","provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:10.628Z"}
error: All AI providers failed - no fallback available {"timestamp":"2025-09-17T14:46:10.629Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
error: Caption generation failed in test {"error":"All AI providers failed","timestamp":"2025-09-17T14:46:10.629Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should handle missing template gracefully
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.756Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should handle missing template gracefully
warn: Gemini provider returned empty response {"timestamp":"2025-09-17T14:46:10.756Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should handle missing template gracefully
warn: AI provider returned empty result {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.757Z"}
info: AI provider attempt {"inputCost":0.8,"provider":"claude-haiku","timestamp":"2025-09-17T14:46:10.757Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should handle missing template gracefully
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'content')","provider":"claude-haiku","timestamp":"2025-09-17T14:46:10.757Z"}
info: AI provider attempt {"inputCost":5,"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:10.757Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should handle missing template gracefully
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'choices')","provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:10.758Z"}
error: All AI providers failed - no fallback available {"timestamp":"2025-09-17T14:46:10.758Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should handle missing template gracefully
error: Caption generation failed in test {"error":"All AI providers failed","timestamp":"2025-09-17T14:46:10.758Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should analyze uploaded images for content generation
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.882Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should analyze uploaded images for content generation
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:10.883Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should analyze uploaded images for content generation
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:10.883Z"}

stdout | tests/integration/auth-flow.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ“¡ auto-backup env with Radar: https://dotenvx.com/radar

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.101Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
warn: Gemini provider returned empty response {"timestamp":"2025-09-17T14:46:11.102Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
warn: AI provider returned empty result {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.103Z"}
info: AI provider attempt {"inputCost":0.8,"provider":"claude-haiku","timestamp":"2025-09-17T14:46:11.103Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'content')","provider":"claude-haiku","timestamp":"2025-09-17T14:46:11.103Z"}
info: AI provider attempt {"inputCost":5,"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:11.103Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'choices')","provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:11.104Z"}
error: All AI providers failed - no fallback available {"timestamp":"2025-09-17T14:46:11.104Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
error: Caption generation failed in test {"error":"All AI providers failed","timestamp":"2025-09-17T14:46:11.104Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should cache AI responses appropriately
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.230Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should cache AI responses appropriately
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.230Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should cache AI responses appropriately
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.231Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.505Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.506Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.507Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.620Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.621Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.621Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.623Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.623Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.623Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.628Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.628Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.628Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.639Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.640Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.640Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should handle database connection failures
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.789Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should handle database connection failures
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:11.790Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should handle database connection failures
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.790Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.949Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
warn: Gemini generation failed {"error":"Service temporarily unavailable","timestamp":"2025-09-17T14:46:11.951Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
warn: AI provider returned empty result {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:11.952Z"}
info: AI provider attempt {"inputCost":0.8,"provider":"claude-haiku","timestamp":"2025-09-17T14:46:11.952Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'content')","provider":"claude-haiku","timestamp":"2025-09-17T14:46:11.952Z"}
info: AI provider attempt {"inputCost":5,"provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:11.952Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
warn: AI provider failed, trying next {"error":"Cannot read properties of undefined (reading 'choices')","provider":"openai-gpt4o","timestamp":"2025-09-17T14:46:11.953Z"}
error: All AI providers failed - no fallback available {"timestamp":"2025-09-17T14:46:11.953Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
error: Caption generation failed in test {"error":"All AI providers failed","timestamp":"2025-09-17T14:46:11.953Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
info: AI provider attempt {"inputCost":0.075,"provider":"gemini-flash","timestamp":"2025-09-17T14:46:12.001Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
info: Gemini generation completed successfully {"timestamp":"2025-09-17T14:46:12.001Z"}

stdout | tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages
info: AI generation successful {"provider":"gemini-flash","timestamp":"2025-09-17T14:46:12.002Z"}

 â¯ tests/integration/content-generation.test.ts (15 tests | 3 failed) 3240ms
   âœ“ Content Generation Integration Tests > AI Provider Fallback Flow > should use primary AI provider when available 246ms
   âœ“ Content Generation Integration Tests > AI Provider Fallback Flow > should fallback to secondary provider on primary failure 187ms
   âœ“ Content Generation Integration Tests > AI Provider Fallback Flow > should use template fallback when all AI providers fail 140ms
   âœ“ Content Generation Integration Tests > Content Generation Flow > should generate platform-specific content 230ms
   âœ“ Content Generation Integration Tests > Content Generation Flow > should respect user tier limitations 215ms
   âœ“ Content Generation Integration Tests > Content Generation Flow > should save generation history 247ms
   âœ“ Content Generation Integration Tests > Content Generation Flow > should apply content filtering and safety checks 127ms
   Ã— Content Generation Integration Tests > Template System Integration > should apply user personalization to templates 135ms
     â†’ expected 'This is a template fallback response â€¦' to contain 'Wellness'
   âœ“ Content Generation Integration Tests > Template System Integration > should handle missing template gracefully 126ms
   âœ“ Content Generation Integration Tests > Image Analysis Integration > should analyze uploaded images for content generation 178ms
   Ã— Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats 168ms
     â†’ expected undefined to be 'unsupported_format' // Object.is equality
   âœ“ Content Generation Integration Tests > Performance and Caching > should cache AI responses appropriately 247ms
   âœ“ Content Generation Integration Tests > Performance and Caching > should handle concurrent generation requests  321ms
   Ã— Content Generation Integration Tests > Error Handling and Recovery > should handle database connection failures 149ms
     â†’ expected '' to contain 'database'
   âœ“ Content Generation Integration Tests > Error Handling and Recovery > should recover from temporary AI provider outages 215ms
stdout | tests/integration/session.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ“¡ observe env with Radar: https://dotenvx.com/radar

 âœ“ tests/integration/auth-flow.test.ts (13 tests) 1393ms
stdout | tests/unit/preview-gate.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 âœ“ tests/integration/upload.test.ts (17 tests) 2652ms
   âœ“ Upload and ImageShield Integration Tests > Performance and Concurrency > should handle multiple concurrent uploads  358ms
stdout | tests/unit/moderation-utils.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

 âœ“ tests/unit/moderation-utils.test.ts (4 tests) 205ms
stdout | tests/unit/auth/login-identifier.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  override existing env vars with { override: true }

 âœ“ tests/unit/preview-gate.test.ts (8 tests) 1360ms
 âœ“ tests/integration/session.test.ts (5 tests) 1901ms
   âœ“ Session Storage Integration > should create and retrieve session data  420ms
   âœ“ Session Storage Integration > should persist session across requests  525ms
   âœ“ Session Storage Integration > should destroy session correctly  485ms
   âœ“ Session Storage Integration > should handle concurrent sessions correctly  459ms
stdout | tests/unit/workers/queue-initialization.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/unit/auth/email-verification.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

stdout | tests/unit/auth/login-identifier.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/unit/auth/login-identifier.test.ts > Login Identifier and Cookie Auth > Email Login with Cookies > should accept email login and set auth cookie
Using cookie authentication
Using token authentication

stdout | tests/unit/auth/email-verification.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should reject missing token
2025-09-17T14:46:16.017Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"No token","origin":"Unknown","responseMode":"JSON"}
2025-09-17T14:46:16.019Z [warn] âŒ EMAIL VERIFICATION FAILED: No token provided

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should reject empty token
2025-09-17T14:46:16.031Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"No token","origin":"Unknown","responseMode":"JSON"}
2025-09-17T14:46:16.031Z [warn] âŒ EMAIL VERIFICATION FAILED: No token provided

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should reject invalid token
2025-09-17T14:46:16.036Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"invalid-...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should reject invalid token
2025-09-17T14:46:16.037Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"invalid-..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should reject expired token
2025-09-17T14:46:16.044Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"expired-...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should reject expired token
2025-09-17T14:46:16.044Z [warn] âŒ EMAIL VERIFICATION FAILED: Token expired {"expiredAt":"2025-09-16T13:46:16.040Z","currentTime":"2025-09-17T14:46:16.044Z"}

stdout | tests/unit/auth/login-identifier.test.ts > Login Identifier and Cookie Auth > Email Login with Cookies > should accept username login and set auth cookie
Using cookie authentication
Using token authentication

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should accept valid unexpired token
2025-09-17T14:46:16.072Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"valid-to...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Validation > should accept valid unexpired token
2025-09-17T14:46:16.073Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"testuser","email":"te***@example.com","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > User State Updates > should mark user as verified after successful token validation
2025-09-17T14:46:16.089Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"verifica...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > User State Updates > should mark user as verified after successful token validation
2025-09-17T14:46:16.090Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"newuser","email":"ne***@example.com","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > User State Updates > should cleanup verification token after successful verification
2025-09-17T14:46:16.094Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"cleanup-...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > User State Updates > should cleanup verification token after successful verification
2025-09-17T14:46:16.095Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"cleanupuser","email":"cl***@example.com","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.105Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"token wi...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.105Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"token wi..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.109Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"token\nwi...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.109Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"token\nwi..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.113Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"token\twi...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.114Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"token\twi..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.117Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"token<sc...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.117Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"token<sc..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.121Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"../../et...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.121Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"../../et..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.124Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"null...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.124Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"null..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.130Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"undefine...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.130Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"undefine..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.135Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"0...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.135Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"0..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.139Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"false...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle malformed tokens gracefully
2025-09-17T14:46:16.139Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"false..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle extremely long tokens
2025-09-17T14:46:16.144Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"aaaaaaaa...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle extremely long tokens
2025-09-17T14:46:16.144Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"aaaaaaaa..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle SQL injection attempts in token
2025-09-17T14:46:16.148Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"'; DROP ...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle SQL injection attempts in token
2025-09-17T14:46:16.148Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"'; DROP ..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle SQL injection attempts in token
2025-09-17T14:46:16.152Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"' OR '1'...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle SQL injection attempts in token
2025-09-17T14:46:16.153Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"' OR '1'..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle SQL injection attempts in token
2025-09-17T14:46:16.168Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"1' UNION...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Edge Cases > should handle SQL injection attempts in token
2025-09-17T14:46:16.168Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"1' UNION..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.243Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"concurre...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.244Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"concurrentuser","email":"co***@example.com","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.246Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"concurre...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.247Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"concurre..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.248Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"concurre...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.248Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"concurre..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.249Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"concurre...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.249Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"concurre..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.250Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"concurre...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Rate Limiting Boundary Tests > should handle multiple concurrent verification requests
2025-09-17T14:46:16.251Z [warn] âŒ EMAIL VERIFICATION FAILED: Token not found in database {"token":"concurre..."}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Expiration Edge Cases > should reject token that expires exactly now
2025-09-17T14:46:16.260Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"edge-exp...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Expiration Edge Cases > should reject token that expires exactly now
2025-09-17T14:46:16.260Z [warn] âŒ EMAIL VERIFICATION FAILED: Token expired {"expiredAt":"2025-09-17T14:46:16.255Z","currentTime":"2025-09-17T14:46:16.260Z"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Expiration Edge Cases > should accept token that expires in 1 minute
2025-09-17T14:46:16.268Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"soon-exp...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/unit/auth/email-verification.test.ts > Email Verification Unit Tests > Token Expiration Edge Cases > should accept token that expires in 1 minute
2025-09-17T14:46:16.270Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"soonexpiry","email":"so***@example.com","responseMode":"JSON"}

 âœ“ tests/unit/auth/email-verification.test.ts (13 tests) 274ms
 âœ“ tests/unit/auth/login-identifier.test.ts (4 tests) 791ms
stdout | tests/integration/billing-flow.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/auth/signup.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/unit/workers/queue-initialization.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: ðŸ“¡ version env with Radar: https://dotenvx.com/radar

 âœ“ tests/integration/billing-flow.test.ts (13 tests) 183ms
stdout | tests/unit/expenses/receipt-upload.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/auth/signup.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: ðŸ“¡ version env with Radar: https://dotenvx.com/radar

 âœ“ tests/unit/workers/queue-initialization.test.ts (6 tests) 584ms
   âœ“ Worker Queue Initialization > Worker Initialization Logging > should log successful worker initialization  548ms
stdout | tests/auth/signup.test.ts > Signup and email verification > verifies email before allowing login
2025-09-17T14:46:17.889Z [info] ðŸ“§ EMAIL VERIFICATION WORKFLOW STARTED {"token":"69c46aef...","origin":"Unknown","responseMode":"JSON"}

stdout | tests/auth/signup.test.ts > Signup and email verification > verifies email before allowing login
2025-09-17T14:46:17.918Z [info] âœ… EMAIL VERIFICATION SUCCESSFUL {"user":"alice","email":"al***@example.com","responseMode":"JSON"}

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should apply light protection for free tier users
2025-09-17T14:46:17.937Z [info] Applying ImageShield protection (light) to receipt for user 1, tier: free

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should apply light protection for free tier users
Receipt ImageShield protection failed: Error: Input buffer has corrupt header: pngload_buffer: invalid chunk checksum
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should apply light protection for free tier users
2025-09-17T14:46:17.949Z [info] Protected receipt uploaded: protected_1758120377949-test-receipt.jpg for expense 1

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should apply watermark for free users
2025-09-17T14:46:17.970Z [info] Applying ImageShield protection (light) to receipt for user 2, tier: free

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should apply watermark for free users
Receipt ImageShield protection failed: Error: Input buffer has corrupt header: pngload_buffer: invalid chunk checksum
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should apply watermark for free users
2025-09-17T14:46:17.977Z [info] Protected receipt uploaded: protected_1758120377977-test-receipt.jpg for expense 2

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should not apply watermark for pro users
2025-09-17T14:46:17.986Z [info] Applying ImageShield protection (light) to receipt for user 3, tier: pro

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should not apply watermark for pro users
Receipt ImageShield protection failed: Error: Input buffer has corrupt header: pngload_buffer: invalid chunk checksum
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > ImageShield Protection Application > should not apply watermark for pro users
2025-09-17T14:46:17.988Z [info] Protected receipt uploaded: protected_1758120377988-test-receipt.jpg for expense 3

 âœ“ tests/auth/signup.test.ts (1 test) 358ms
   âœ“ Signup and email verification > verifies email before allowing login  356ms
stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > S3 Upload Integration > should use S3 when configured
2025-09-17T14:46:18.085Z [info] Applying ImageShield protection (light) to receipt for user 1, tier: free

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > S3 Upload Integration > should use S3 when configured
Receipt ImageShield protection failed: Error: Input buffer has corrupt header: pngload_buffer: invalid chunk checksum
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > S3 Upload Integration > should use S3 when configured
2025-09-17T14:46:18.091Z [info] Protected receipt uploaded: protected_test.jpg for expense 1

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > S3 Upload Integration > should use local storage when S3 not configured
2025-09-17T14:46:18.102Z [info] Applying ImageShield protection (light) to receipt for user 1, tier: free

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > S3 Upload Integration > should use local storage when S3 not configured
Receipt ImageShield protection failed: Error: Input buffer has corrupt header: pngload_buffer: invalid chunk checksum
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > S3 Upload Integration > should use local storage when S3 not configured
2025-09-17T14:46:18.104Z [info] Protected receipt uploaded: protected_1758120378104-test-receipt.jpg for expense 1

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > Error Handling > should handle storage errors gracefully
2025-09-17T14:46:18.117Z [info] Applying ImageShield protection (light) to receipt for user 1, tier: free

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > Error Handling > should handle storage errors gracefully
Receipt ImageShield protection failed: Error: Input buffer has corrupt header: pngload_buffer: invalid chunk checksum
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > Error Handling > should handle storage errors gracefully
Error uploading receipt: Error: Database error
    at /home/runner/workspace/tests/unit/expenses/receipt-upload.test.ts:252:51
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at runSuite (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stdout | tests/unit/payment-providers.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ“¡ observe env with Radar: https://dotenvx.com/radar

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > Error Handling > should handle ImageShield protection errors
2025-09-17T14:46:18.132Z [info] Applying ImageShield protection (light) to receipt for user 1, tier: free

stderr | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > Error Handling > should handle ImageShield protection errors
Receipt ImageShield protection failed: Error: Input buffer contains unsupported image format
    at Sharp.metadata (/home/runner/workspace/node_modules/sharp/lib/input.js:639:17)
    at applyReceiptImageShieldProtection (/home/runner/workspace/server/expense-routes.ts:89:39)
    at /home/runner/workspace/server/expense-routes.ts:275:37
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at done (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:59:7)
    at indicateDone (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:63:68)
    at Multipart.<anonymous> (/home/runner/workspace/node_modules/multer/lib/make-middleware.js:187:7)
    at Multipart.emit (node:events:524:28)
    at emitCloseNT (node:internal/streams/destroy:147:10)

stdout | tests/unit/expenses/receipt-upload.test.ts > Receipt Upload with ImageShield Protection > Error Handling > should handle ImageShield protection errors
2025-09-17T14:46:18.134Z [info] Protected receipt uploaded: protected_1758120378134-test-receipt.jpg for expense 1

 âœ“ tests/unit/expenses/receipt-upload.test.ts (10 tests) 293ms
stderr | tests/unit/payment-providers.test.ts > Payment Providers > Coinbase Provider > handles API errors properly
Coinbase Commerce checkout creation failed: Error: Failed to create Coinbase Commerce checkout session
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:106:17)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)

stderr | tests/unit/payment-providers.test.ts > Payment Providers > Edge Cases and Error Handling > Network Errors and API Failures > handles network timeout for Coinbase
Coinbase Commerce checkout creation failed: Error: Network timeout
    at global.fetch (/home/runner/workspace/tests/unit/payment-providers.test.ts:258:17)
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:81:26)
    at /home/runner/workspace/tests/unit/payment-providers.test.ts:262:9
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stderr | tests/unit/payment-providers.test.ts > Payment Providers > Edge Cases and Error Handling > Network Errors and API Failures > handles malformed JSON response from Coinbase
Coinbase Commerce checkout creation failed: Error: Unexpected end of JSON input
    at Object.json (/home/runner/workspace/tests/unit/payment-providers.test.ts:278:19)
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:111:37)

stderr | tests/unit/payment-providers.test.ts > Payment Providers > Edge Cases and Error Handling > Network Errors and API Failures > handles missing hosted_url in Coinbase response
Coinbase Commerce checkout creation failed: Error: Invalid response from Coinbase Commerce API
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:115:17)
    at /home/runner/workspace/tests/unit/payment-providers.test.ts:308:9
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stderr | tests/unit/payment-providers.test.ts > Payment Providers > Edge Cases and Error Handling > Network Errors and API Failures > handles rate limiting responses
Coinbase Commerce checkout creation failed: Error: Failed to create Coinbase Commerce checkout session
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:106:17)

stderr | tests/unit/payment-providers.test.ts > Payment Providers > Edge Cases and Error Handling > Input Validation > validates required fields for Paxum
Promise returned by `expect(actual).rejects.toThrow()` was not awaited. Vitest currently auto-awaits hanging assertions at the end of the test, but this will cause the test to fail in Vitest 3. Please remember to await the assertion.
    at /home/runner/workspace/tests/unit/payment-providers.test.ts:354:49

stderr | tests/unit/payment-providers.test.ts > Payment Providers > Edge Cases and Error Handling > Input Validation > validates required fields for Paxum
Promise returned by `expect(actual).rejects.toThrow()` was not awaited. Vitest currently auto-awaits hanging assertions at the end of the test, but this will cause the test to fail in Vitest 3. Please remember to await the assertion.
    at /home/runner/workspace/tests/unit/payment-providers.test.ts:348:49

stdout | tests/integration/workflow.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

 âœ“ tests/unit/payment-providers.test.ts (27 tests) 147ms
stdout | tests/routes/caption-generation.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  override existing env vars with { override: true }

stdout | tests/integration/workflow.test.ts > End-to-End Content Generation Workflow > Image-to-Content Pipeline > should complete full workflow from image to final content
Starting fact extraction for image: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxITEhUSEhIVFRUVGBcWFRUVFRUVFRUVFRcWFhUVF...

stdout | tests/integration/workflow.test.ts > End-to-End Content Generation Workflow > Image-to-Content Pipeline > should complete full workflow from image to final content
Processing data URL with mime type: image/jpeg, data length: 11324
Base64 starts with: /9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxITEhUSEhIVFR...
Sending to Gemini for fact extraction...

stdout | tests/integration/workflow.test.ts > End-to-End Content Generation Workflow > Image-to-Content Pipeline > should complete full workflow from image to final content
Fact extraction completed successfully

stdout | tests/routes/caption-generation.test.ts > Caption Generation > Gemini Pipeline > should handle image-based caption generation
Starting fact extraction for image: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAP///////////////wAALCAABAAEBAREA/8QAFAABAAAA...

stdout | tests/routes/caption-generation.test.ts > Caption Generation > Gemini Pipeline > should handle image-based caption generation
Processing data URL with mime type: image/jpeg, data length: 140
Base64 starts with: /9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAP///////////////w...
Sending to Gemini for fact extraction...

stdout | tests/routes/caption-generation.test.ts > Caption Generation > Gemini Pipeline > should handle image-based caption generation
Fact extraction completed successfully

 âœ“ tests/integration/workflow.test.ts (7 tests) 50ms
 âœ“ tests/routes/caption-generation.test.ts (4 tests) 32ms
stdout | tests/routes/admin.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/routes/health.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  override existing env vars with { override: true }

stdout | tests/unit/email-service.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

 âœ“ tests/routes/admin.test.ts (3 tests) 125ms
 âœ“ tests/unit/email-service.test.ts (10 tests) 72ms
 âœ“ tests/routes/health.test.ts (1 test) 74ms
stdout | tests/unit/payment-providers-fixed.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/unit/caption/nsfw-fallback.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

stderr | tests/unit/payment-providers-fixed.test.ts > Payment Providers - Fixed > Coinbase Provider Fixes > handles malformed JSON with specific error
Coinbase Commerce checkout creation failed: Error: Unexpected end of JSON input
    at Object.json (/home/runner/workspace/tests/unit/payment-providers-fixed.test.ts:59:17)
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:111:37)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)

stderr | tests/unit/payment-providers-fixed.test.ts > Payment Providers - Fixed > Coinbase Provider Fixes > handles missing hosted_url correctly
Coinbase Commerce checkout creation failed: Error: Invalid response from Coinbase Commerce API
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:115:17)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at /home/runner/workspace/tests/unit/payment-providers-fixed.test.ts:91:7
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stderr | tests/unit/payment-providers-fixed.test.ts > Payment Providers - Fixed > Coinbase Provider Fixes > validates required fields
Coinbase Commerce checkout creation failed: Error: userId and planId are required
    at Object.createCheckout (/home/runner/workspace/server/payments/payment-providers.ts:75:17)
    at /home/runner/workspace/tests/unit/payment-providers-fixed.test.ts:122:29
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at runSuite (file:///home/runner/workspace/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

 âœ“ tests/unit/payment-providers-fixed.test.ts (8 tests) 25ms
stdout | tests/theme-system.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

 âœ“ tests/unit/caption/nsfw-fallback.test.ts (1 test) 71ms
 âœ“ tests/theme-system.test.ts (19 tests) 20ms
stdout | tests/routes/billing.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

 âœ“ tests/routes/billing.test.ts (6 tests) 12ms
stdout | tests/unit/caption/suggestive-safety-level.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 âœ“ tests/unit/caption/suggestive-safety-level.test.ts (4 tests) 21ms
stdout | tests/integration/reddit/posting-flow.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/reddit/posting-flow.test.ts > Reddit Integration > should submit a link post successfully
Submitting post to r/test: "Test Link Post"

stdout | tests/integration/reddit/posting-flow.test.ts > Reddit Integration > should submit a link post successfully
Updated rate limit for user 1 in r/test

stdout | tests/unit/image-generator/enhanced-ai-service.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/reddit/posting-flow.test.ts > Reddit Integration > should submit a link post successfully
Reddit submission succeeded: { userId: 1, subreddit: 'test', postId: 'test_link_post_id' }

stdout | tests/integration/reddit/posting-flow.test.ts > Reddit Integration > should submit a text post successfully
Submitting post to r/test: "Test Text Post"

stdout | tests/integration/reddit/posting-flow.test.ts > Reddit Integration > should submit a text post successfully
Updated rate limit for user 1 in r/test

stdout | tests/integration/reddit/posting-flow.test.ts > Reddit Integration > should submit a text post successfully
Reddit submission succeeded: { userId: 1, subreddit: 'test', postId: 'test_text_post_id' }

 âœ“ tests/integration/reddit/posting-flow.test.ts (3 tests) 15ms
 âœ“ tests/unit/image-generator/enhanced-ai-service.test.ts (8 tests) 20ms
stdout | tests/unit/image-generator/generation-failure-paths.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 âœ“ tests/unit/image-generator/generation-failure-paths.test.ts (5 tests) 24ms
stdout | tests/lib/storage.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

stdout | tests/unit/image-generator/ai-failure-scenarios.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

stdout | tests/unit/payments/stripe-config.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ“¡ auto-backup env with Radar: https://dotenvx.com/radar

 âœ“ tests/unit/image-generator/ai-failure-scenarios.test.ts (10 tests) 12ms
 âœ“ tests/unit/payments/stripe-config.test.ts (5 tests) 9ms
stdout | tests/unit/payment-providers-lib.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

stdout | tests/lib/storage-quotas.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 âœ“ tests/lib/storage-quotas.test.ts (8 tests) 11ms
 âœ“ tests/unit/payment-providers-lib.test.ts (2 tests) 9ms
stdout | tests/lib/storage.test.ts
[dotenv@17.2.2] injecting env (0) from .env -- tip: ðŸ“¡ version env with Radar: https://dotenvx.com/radar

 âœ“ tests/lib/storage.test.ts (7 tests) 12ms
stdout | moderation/validateContent.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

stdout | tests/categorizeContent.test.ts
[dotenv@17.2.2] injecting env (2) from .env.test -- tip: âš™ï¸  suppress all logs with { quiet: true }

 âœ“ tests/categorizeContent.test.ts (4 tests) 17ms
 âœ“ moderation/validateContent.test.ts (5 tests) 8ms

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯ Failed Tests 38 âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯

 FAIL  tests/integration/content-generation.test.ts > Content Generation Integration Tests > Template System Integration > should apply user personalization to templates
AssertionError: expected 'This is a template fallback response â€¦' to contain 'Wellness'

Expected: "Wellness"
Received: "This is a template fallback response when all AI providers fail."

 â¯ tests/integration/content-generation.test.ts:492:37
    490| 
    491|       expect(response.status).toBe(200);
    492|       expect(response.body.content).toContain('Wellness');
       |                                     ^
    493|     });
    494| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/38]âŽ¯

 FAIL  tests/integration/content-generation.test.ts > Content Generation Integration Tests > Image Analysis Integration > should handle unsupported image formats
AssertionError: expected undefined to be 'unsupported_format' // Object.is equality

- Expected: 
"unsupported_format"

+ Received: 
undefined

 â¯ tests/integration/content-generation.test.ts:553:40
    551| 
    552|       expect(response.status).toBe(200);
    553|       expect(response.body.imageError).toBe('unsupported_format');
       |                                        ^
    554|       expect(response.body.fallbackUsed).toBe(true);
    555|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/38]âŽ¯

 FAIL  tests/integration/content-generation.test.ts > Content Generation Integration Tests > Error Handling and Recovery > should handle database connection failures
AssertionError: expected '' to contain 'database'

- Expected
+ Received

- database

 â¯ tests/integration/content-generation.test.ts:656:43
    654| 
    655|       expect([200, 500]).toContain(response.status);
    656|       expect(response.body.message || "").toContain('database');
       |                                           ^
    657|       expect(response.body.fallbackAvailable).toBe(true);
    658| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Blocked Content > blocks content with banned words
AssertionError: expected [ 'Contains banned terms', â€¦(1) ] to include StringContaining "Contains banned terms"
 â¯ tests/unit/policy-linter.test.ts:37:31
     35| 
     36|       expect(result.state).toBe('block');
     37|       expect(result.warnings).toContain(expect.stringContaining('Contains banned terms'));
       |                               ^
     38|     });
     39| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Blocked Content > blocks content matching title regex patterns
AssertionError: expected [ Array(2) ] to include StringContaining{â€¦}
 â¯ tests/unit/policy-linter.test.ts:49:31
     47| 
     48|       expect(result.state).toBe('block');
     49|       expect(result.warnings).toContain(expect.stringContaining('Title violates pattern rules'));
       |                               ^
     50|     });
     51| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Blocked Content > blocks content with prohibited links
AssertionError: expected [ â€¦(2) ] to include StringContaining{â€¦}
 â¯ tests/unit/policy-linter.test.ts:61:31
     59| 
     60|       expect(result.state).toBe('block');
     61|       expect(result.warnings).toContain(expect.stringContaining('Content violates formatting rules'));
       |                               ^
     62|     });
     63| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Blocked Content > blocks content exceeding length limits
AssertionError: expected [ 'Missing required tags', 'too long' ] to include StringContaining "too long"
 â¯ tests/unit/policy-linter.test.ts:75:31
     73| 
     74|       expect(result.state).toBe('warn'); // Length limits are warnings, not blocks
     75|       expect(result.warnings).toContain(expect.stringContaining('too long'));
       |                               ^
     76|     });
     77|   });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Warning Content > warns on missing required tags
AssertionError: expected [ 'Missing required tags' ] to include StringContaining "Missing required tags"
 â¯ tests/unit/policy-linter.test.ts:89:31
     87| 
     88|       expect(result.state).toBe('warn');
     89|       expect(result.warnings).toContain(expect.stringContaining('Missing required tags'));
       |                               ^
     90|     });
     91| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Warning Content > warns on short content
AssertionError: expected [ Array(2) ] to include StringContaining "too short"
 â¯ tests/unit/policy-linter.test.ts:101:31
     99| 
    100|       expect(result.state).toBe('warn');
    101|       expect(result.warnings).toContain(expect.stringContaining('too short'));
       |                               ^
    102|     });
    103|   });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/38]âŽ¯

 FAIL  tests/unit/policy-linter.test.ts > Policy Linter > Clean Content > handles unknown subreddits with default rules
AssertionError: expected 'block' to be 'ok' // Object.is equality

Expected: "ok"
Received: "block"

 â¯ tests/unit/policy-linter.test.ts:126:28
    124|       });
    125| 
    126|       expect(result.state).toBe('ok');
       |                            ^
    127|     });
    128|   });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/38]âŽ¯

 FAIL  tests/unit/auth/email-verification-redirect.test.ts > Email Verification Redirect Tests > should return JSON success response on valid token in test environment
AssertionError: expected "spy" to be called with arguments: [ 'test@example.com', 'testuser' ]

Number of calls: 0

 â¯ tests/unit/auth/email-verification-redirect.test.ts:63:47
     61|     expect(mockStorage.updateUserEmailVerified).toHaveBeenCalledWith(1, true);
     62|     expect(mockStorage.deleteVerificationToken).toHaveBeenCalledWith(validToken);
     63|     expect(mockEmailService.sendWelcomeEmail).toHaveBeenCalledWith('test@example.com', 'testuser');
       |                                               ^
     64|   });
     65| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/38]âŽ¯

 FAIL  tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategories > should fetch all active expense categories
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/expenses/expense-categories.test.ts:92:24
     90| 
     91|       expect(db.select).toHaveBeenCalled();
     92|       expect(db.where).toHaveBeenCalled();
       |                        ^
     93|       expect(result).toEqual(mockCategories);
     94|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/38]âŽ¯

 FAIL  tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > updateExpenseCategory > should update category successfully
TypeError: Cannot read properties of undefined (reading 'id')
 â¯ DatabaseStorage.updateExpenseCategory server/storage.ts:736:37
    734|       const [result] = await db.update(expenseCategories)
    735|         .set(updates)
    736|         .where(eq(expenseCategories.id, id))
       |                                     ^
    737|         .returning();
    738|       return result;
 â¯ tests/unit/expenses/expense-categories.test.ts:131:36

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/38]âŽ¯

 FAIL  tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > updateExpenseCategory > should handle update error
 FAIL  tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > deleteExpenseCategory > should handle deletion error
AssertionError: expected [Function] to throw error including 'Category not found' but got 'Cannot read properties of undefined (â€¦'

Expected: "Category not found"
Received: "Cannot read properties of undefined (reading 'id')"

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/38]âŽ¯

 FAIL  tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > deleteExpenseCategory > should soft delete category (set isActive to false)
TypeError: Cannot read properties of undefined (reading 'id')
 â¯ DatabaseStorage.deleteExpenseCategory server/storage.ts:749:37
    747|       await db.update(expenseCategories)
    748|         .set({ isActive: false })
    749|         .where(eq(expenseCategories.id, id));
       |                                     ^
    750|     } catch (error) {
    751|       console.error('Error deleting expense category:', { error: (error as Error).message });
 â¯ tests/unit/expenses/expense-categories.test.ts:155:21

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/38]âŽ¯

 FAIL  tests/unit/expenses/expense-categories.test.ts > Expense Categories Unit Tests > getExpenseCategory > should fetch single category by ID
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/expenses/expense-categories.test.ts:187:24
    185| 
    186|       expect(db.select).toHaveBeenCalled();
    187|       expect(db.where).toHaveBeenCalled();
       |                        ^
    188|       expect(db.limit).toHaveBeenCalledWith(1);
    189|       expect(result).toEqual(mockCategory);

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > createExpense > should create expense with valid data
AssertionError: expected "spy" to be called with arguments: [ Anything ]

Received: 

  1st spy call:

  [
-   Anything,
+   undefined,
  ]


Number of calls: 1

 â¯ tests/unit/expenses/expense-operations.test.ts:63:25
     61|       const result = await storage.createExpense(expenseData);
     62| 
     63|       expect(db.insert).toHaveBeenCalledWith(expect.anything());
       |                         ^
     64|       expect(db.values).toHaveBeenCalledWith(expenseData);
     65|       expect(db.returning).toHaveBeenCalled();

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > createExpense > should handle expense creation error
AssertionError: expected [Function] to throw error including 'Database error' but got 'Cannot read properties of undefined (â€¦'

Expected: "Database error"
Received: "Cannot read properties of undefined (reading 'values')"

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > createExpense > should create expense with optional fields
TypeError: Cannot read properties of undefined (reading 'values')
 â¯ DatabaseStorage.createExpense server/storage.ts:760:25
    758|     try {
    759|       const [result] = await db
    760|         .insert(expenses)
       |                         ^
    761|         .values(expense as typeof expenses.$inferInsert)
    762|         .returning();
 â¯ tests/unit/expenses/expense-operations.test.ts:108:36

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > deleteExpense > should delete expense with valid ID and userId
TypeError: Cannot read properties of undefined (reading 'where')
 â¯ DatabaseStorage.deleteExpense server/storage.ts:821:31
    819|   async deleteExpense(id: number, userId: number): Promise<void> {
    820|     try {
    821|       await db.delete(expenses)
       |                               ^
    822|         .where(and(eq(expenses.id, id), eq(expenses.userId, userId)));
    823|     } catch (error) {
 â¯ tests/unit/expenses/expense-operations.test.ts:121:21

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > deleteExpense > should handle deletion error
AssertionError: expected [Function] to throw error including 'Expense not found' but got 'Cannot read properties of undefined (â€¦'

Expected: "Expense not found"
Received: "Cannot read properties of undefined (reading 'where')"

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > deleteExpense > should only delete expense owned by user
TypeError: Cannot read properties of undefined (reading 'where')
 â¯ DatabaseStorage.deleteExpense server/storage.ts:821:31
    819|   async deleteExpense(id: number, userId: number): Promise<void> {
    820|     try {
    821|       await db.delete(expenses)
       |                               ^
    822|         .where(and(eq(expenses.id, id), eq(expenses.userId, userId)));
    823|     } catch (error) {
 â¯ tests/unit/expenses/expense-operations.test.ts:139:21

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should calculate expense totals correctly
AssertionError: expected { total: +0, deductible: +0, â€¦(1) } to deeply equal { total: 85000, â€¦(2) }

- Expected
+ Received

  {
-   "byCategory": {
-     "Beauty & Wellness": 10000,
-     "Technology": 50000,
-     "Travel": 25000,
-   },
-   "deductible": 72500,
-   "total": 85000,
+   "byCategory": {},
+   "deductible": 0,
+   "total": 0,
  }

 â¯ tests/unit/expenses/expense-operations.test.ts:158:22
    156|       const result = await storage.getExpenseTotals(userId, 2024);
    157| 
    158|       expect(result).toEqual({
       |                      ^
    159|         total: 85000, // $850.00 total
    160|         deductible: 72500, // $725.00 deductible (10000 + 50000 + 12500)

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should filter by tax year when specified
AssertionError: expected +0 to be 5000 // Object.is equality

- Expected
+ Received

- 5000
+ 0

 â¯ tests/unit/expenses/expense-operations.test.ts:192:28
    190|       const result = await storage.getExpenseTotals(userId, taxYear);
    191| 
    192|       expect(result.total).toBe(5000);
       |                            ^
    193|       expect(db.where).toHaveBeenCalled();
    194|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should handle partial deduction percentages
AssertionError: expected { total: +0, deductible: +0, â€¦(1) } to deeply equal { total: 50000, â€¦(2) }

- Expected
+ Received

  {
-   "byCategory": {
-     "Home Office": 30000,
-     "Mixed Use Equipment": 20000,
-   },
-   "deductible": 24000,
-   "total": 50000,
+   "byCategory": {},
+   "deductible": 0,
+   "total": 0,
  }

 â¯ tests/unit/expenses/expense-operations.test.ts:206:22
    204|       const result = await storage.getExpenseTotals(userId);
    205| 
    206|       expect(result).toEqual({
       |                      ^
    207|         total: 50000, // $500.00 total
    208|         deductible: 24000, // $240.00 deductible (15000 + 9000)

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getExpenseTotals > should handle database error in totals calculation
AssertionError: promise resolved "{ total: +0, deductible: +0, â€¦(1) }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "byCategory": {},
+   "deductible": 0,
+   "total": 0,
  }

 â¯ tests/unit/expenses/expense-operations.test.ts:219:58
    217|       (db.where as ReturnType<typeof vi.fn>).mockRejectedValueOnce(new Error('Database connection failed'));
    218| 
    219|       await expect(storage.getExpenseTotals(userId, 2024)).rejects.toThrow('Database connection failed');
       |                                                          ^
    220|     });
    221|   });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > updateExpense > should update expense with receipt information
TypeError: Cannot read properties of undefined (reading 'set')
 â¯ DatabaseStorage.updateExpense server/storage.ts:808:48
    806|   async updateExpense(id: number, userId: number, updates: Partial<Expense>): Promise<Expense> {
    807|     try {
    808|       const [result] = await db.update(expenses)
       |                                                ^
    809|         .set({ ...updates, updatedAt: new Date() })
    810|         .where(and(eq(expenses.id, id), eq(expenses.userId, userId)))
 â¯ tests/unit/expenses/expense-operations.test.ts:243:36

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > updateExpense > should update expense amount
TypeError: Cannot read properties of undefined (reading 'set')
 â¯ DatabaseStorage.updateExpense server/storage.ts:808:48
    806|   async updateExpense(id: number, userId: number, updates: Partial<Expense>): Promise<Expense> {
    807|     try {
    808|       const [result] = await db.update(expenses)
       |                                                ^
    809|         .set({ ...updates, updatedAt: new Date() })
    810|         .where(and(eq(expenses.id, id), eq(expenses.userId, userId)))
 â¯ tests/unit/expenses/expense-operations.test.ts:266:36

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > updateExpense > should handle update error
AssertionError: expected [Function] to throw error including 'Update failed' but got 'Cannot read properties of undefined (â€¦'

Expected: "Update failed"
Received: "Cannot read properties of undefined (reading 'set')"

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getUserExpenses > should fetch user expenses with category information
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/expenses/expense-operations.test.ts:308:27
    306| 
    307|       expect(db.select).toHaveBeenCalled();
    308|       expect(db.leftJoin).toHaveBeenCalled();
       |                           ^
    309|       expect(db.where).toHaveBeenCalled();
    310|       expect(result).toEqual(mockExpensesWithCategories);

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/38]âŽ¯

 FAIL  tests/unit/expenses/expense-operations.test.ts > Expense Operations Unit Tests > getUserExpenses > should fetch expenses without tax year filter
AssertionError: expected [] to deeply equal [ â€¦(2) ]

- Expected
+ Received

- [
-   {
-     "category": {
-       "name": "Category 1",
-     },
-     "expense": {
-       "description": "Expense 1",
-       "id": 1,
-       "taxYear": 2023,
-       "userId": 123,
-     },
-   },
-   {
-     "category": {
-       "name": "Category 2",
-     },
-     "expense": {
-       "description": "Expense 2",
-       "id": 2,
-       "taxYear": 2024,
-       "userId": 123,
-     },
-   },
- ]
+ []

 â¯ tests/unit/expenses/expense-operations.test.ts:329:22
    327|       const result = await storage.getUserExpenses(userId);
    328| 
    329|       expect(result).toEqual(mockAllExpenses);
       |                      ^
    330|       expect(db.where).toHaveBeenCalled();
    331|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/38]âŽ¯

 FAIL  tests/unit/image-generator/ai-service.test.ts > AI Service Unit Tests > Environment Variable Handling > should handle missing OPENAI_API_KEY gracefully
Error: All AI providers failed
 â¯ Module.generateWithMultiProvider server/services/multi-ai-provider.ts:96:9
     94|   
     95|   safeLog('error', 'All AI providers failed - no fallback available', {});
     96|   throw new Error('All AI providers failed');
       |         ^
     97| }
     98| 
 â¯ tests/unit/image-generator/ai-service.test.ts:63:22

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/38]âŽ¯

 FAIL  tests/unit/image-generator/ai-service.test.ts > AI Service Unit Tests > AI Provider Fallback Logic > should fallback from Gemini to OpenAI on quota error
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/image-generator/ai-service.test.ts:157:42
    155|       expect(result.titles).toEqual(['Fallback from OpenAI']);
    156|       expect(result.provider).toBeDefined();
    157|       expect(mockGemini.generateContent).toHaveBeenCalled();
       |                                          ^
    158|       expect(mockOpenAI.chat.completions.create).toHaveBeenCalled();
    159|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/38]âŽ¯

 FAIL  tests/unit/image-generator/ai-service.test.ts > AI Service Unit Tests > AI Provider Fallback Logic > should fallback through all providers on consecutive failures
AssertionError: expected "spy" to be called at least once
 â¯ tests/unit/image-generator/ai-service.test.ts:181:42
    179|       })).rejects.toThrow();
    180| 
    181|       expect(mockGemini.generateContent).toHaveBeenCalled();
       |                                          ^
    182|       expect(mockOpenAI.chat.completions.create).toHaveBeenCalled();
    183|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/38]âŽ¯

 FAIL  tests/unit/image-generator/ai-service.test.ts > AI Service Unit Tests > Cost Optimization > should prioritize cheapest provider (Gemini) when available
Error: All AI providers failed
 â¯ Module.generateWithMultiProvider server/services/multi-ai-provider.ts:96:9
     94|   
     95|   safeLog('error', 'All AI providers failed - no fallback available', {});
     96|   throw new Error('All AI providers failed');
       |         ^
     97| }
     98| 
 â¯ tests/unit/image-generator/ai-service.test.ts:314:22

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/38]âŽ¯

 FAIL  tests/unit/image-generator/ai-service.test.ts > AI Service Unit Tests > Platform-Specific Optimizations > should generate Instagram-optimized content
Error: All AI providers failed
 â¯ Module.generateWithMultiProvider server/services/multi-ai-provider.ts:96:9
     94|   
     95|   safeLog('error', 'All AI providers failed - no fallback available', {});
     96|   throw new Error('All AI providers failed');
       |         ^
     97| }
     98| 
 â¯ tests/unit/image-generator/ai-service.test.ts:386:22

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/38]âŽ¯

 FAIL  tests/unit/image-generator/ai-service.test.ts > AI Service Unit Tests > Platform-Specific Optimizations > should generate Reddit-appropriate content without hashtags
Error: All AI providers failed
 â¯ Module.generateWithMultiProvider server/services/multi-ai-provider.ts:96:9
     94|   
     95|   safeLog('error', 'All AI providers failed - no fallback available', {});
     96|   throw new Error('All AI providers failed');
       |         ^
     97| }
     98| 
 â¯ tests/unit/image-generator/ai-service.test.ts:415:22

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/38]âŽ¯


 Test Files  6 failed | 32 passed (38)
      Tests  38 failed | 269 passed (307)
   Start at  14:46:07
   Duration  15.12s (transform 1.72s, setup 1.33s, collect 14.22s, tests 14.81s, environment 14ms, prepare 4.93s)

~/workspace$ 