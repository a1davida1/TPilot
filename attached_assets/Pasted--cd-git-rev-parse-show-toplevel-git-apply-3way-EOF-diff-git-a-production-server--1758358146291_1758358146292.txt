 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/production-server.js b/production-server.js
index 023cde34cdd54ccde529b1fa9df90981a8773c69..00a6077b40ae4f6eb490bc123740aabfdd5cfeda 100644
--- a/production-server.js
+++ b/production-server.js
@@ -1,25 +1,77 @@
 #!/usr/bin/env node
 
+import { existsSync } from 'node:fs';
+import { dirname, join } from 'node:path';
+import { fileURLToPath } from 'node:url';
+import { spawnSync } from 'node:child_process';
+
 /**
  * Production server entry point
  * This file provides an ESM wrapper to run the TypeScript server in production
  */
 
+const currentDir = dirname(fileURLToPath(import.meta.url));
+
+const ensureProductionBuild = () => {
+  const clientIndex = join(currentDir, 'dist', 'client', 'index.html');
+  const serverIndex = join(currentDir, 'dist', 'server', 'index.js');
+
+  if (existsSync(clientIndex) && existsSync(serverIndex)) {
+    return;
+  }
+
+  const buildScript = join(currentDir, 'build-production.sh');
+  const isWindows = process.platform === 'win32';
+  let command;
+  let args;
+
+  if (!isWindows && existsSync(buildScript)) {
+    command = 'bash';
+    args = [buildScript];
+  } else {
+    command = isWindows ? 'npm.cmd' : 'npm';
+    args = ['run', 'build'];
+  }
+
+  const result = spawnSync(command, args, {
+    cwd: currentDir,
+    stdio: 'inherit',
+    env: process.env,
+  });
+
+  if (result.error) {
+    console.error('Failed to run production build:', result.error);
+  }
+
+  const exitStatus = typeof result.status === 'number' ? result.status : 1;
+
+  if (exitStatus !== 0) {
+    process.exit(exitStatus);
+  }
+
+  if (!existsSync(clientIndex) || !existsSync(serverIndex)) {
+    console.error('Production build did not produce expected artifacts.');
+    process.exit(1);
+  }
+};
+
 // Load environment variables
 if (process.env.NODE_ENV === 'production') {
   process.env.NODE_OPTIONS = '--max-old-space-size=4096';
 }
 
 // Run the server
 const startServer = async () => {
+  ensureProductionBuild();
+
   // Register tsx to handle TypeScript files
   await import('tsx/cjs');
-  
+
   // Load and run the main server
   await import('./server/index.ts');
 };
 
 startServer().catch(err => {
   console.error('Failed to start production server:', err);
   process.exit(1);
 });
 
EOF
)