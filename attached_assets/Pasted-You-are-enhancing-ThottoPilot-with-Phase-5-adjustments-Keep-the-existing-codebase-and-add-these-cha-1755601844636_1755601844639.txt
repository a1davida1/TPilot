You are enhancing ThottoPilot with Phase 5 adjustments. Keep the existing codebase and add these changes with minimal diffs, typed code, and tests.

## 1) Queue provider abstraction (Redis optional)
- Create an interface `IQueue` with methods: enqueue(name,payload,opts), process(name, handler, opts), pause(name), resume(name), getFailureRate(name, windowMins).
- Implement `RedisBullQueue` (BullMQ) when REDIS_URL is set (current behavior).
- Implement `PgQueue` fallback using pg-boss (preferred) OR a simple jobs table with `FOR UPDATE SKIP LOCKED` and visibility time.
- Make postQ, metricsQ, aiPromoQ use IQueue via a factory: `getQueueBackend()`.
- Ensure dead-letter handling and feature-flag pause works in both backends.
- Tests: enqueue/process for both backends; failure-rate calc parity.

## 2) Storage quotas & protection updates
- Config: Free=2GB, Pro=25GB (env-overridable). Support a PRO_PLUS=50GB plan flag.
- Enforce quotas before issuing upload URLs; compute SHA-256 (client-provided or server) and dedupe identical assets (link to same MediaAsset).
- Generate WebP preview thumbnails (max width 1920) for UI; originals remain private.
- Auto-prune job (monthly): soft-delete assets unused > 90 days (configurable).
- Keep signed GET URLs; default TTL 10–15 min. Keep watermark preview option.

## 3) Referrals simplification (MVP)
- Add optional User.referralCodeId and Invoice.referralCodeId.
- On signup with ?ref=CODE, set user.referralCodeId and keep ReferralCode sharePct.
- When creating an Invoice, stamp referralCodeId from user onto invoice.
- Ambassador dashboard computes commissions as SUM(invoice.amountCents * sharePct) where status='paid'.
- Remove or hide “commission pending entries” for now; keep accounting later.

## 4) Payments rails (non-Stripe)
- Keep CCBill provider. Add adapters scaffolds for Segpay and Epoch (create/cancel sub, hosted checkout, webhooks with signature verify).
- Add Paxum payout/collection support (manual invoice flow acceptable initially).
- Add Coinbase Commerce or BTCPay for crypto one-time and recurring (if supported), else manual renewal reminders.
- Dunning: on failed rebill, present 1-click “switch rail” options; log attempts.

## 5) Safety & spam hygiene
- Per-subreddit rate limit: default max 1 post / 24h / subreddit / account (env override).
- Near-duplicate detector: Levenshtein or MinHash on title/body to block repeats within 14 days unless overridden.
- Keep preview gate (>=3 ok previews in last 14 days) and policy linter.

## ENV updates (zod-validated)
- PLAN_STORAGE_BYTES_FREE, PLAN_STORAGE_BYTES_PRO, PLAN_STORAGE_BYTES_PRO_PLUS (optional)
- USE_PG_QUEUE=true|false (auto-enable when no REDIS_URL)
- Optional: COINBASE_COMMERCE_KEY, PAXUM_API_KEY, EPOCH/SEGPAY creds

## Acceptance
- App runs with or without REDIS_URL (queues functional both ways).
- Storage quotas enforced; dedupe works; previews are private with signed URLs.
- Referral dashboard shows commissions computed from invoices (no separate pending rows).
- Payment UI offers alternate rails; dunning can switch rails and logs events.
- Safety: per-sub rate-limit + duplicate detection active; preview gate unchanged.
- Tests added for queue backends, quota enforcement, referral commission calc.
