# Database Schema Fixes

## Overview
This document describes the database schema fixes needed for the beta launch.

## Missing Columns Added

### 1. `reddit_post_outcomes` table
- `success` (BOOLEAN) - Whether the post was successful
- `title` (TEXT) - The title of the post
- `upvotes` (INTEGER) - Number of upvotes
- `views` (INTEGER) - Number of views

### 2. `reddit_communities` table
- `over18` (BOOLEAN) - Whether the community is NSFW
- `allow_images` (BOOLEAN) - Whether images are allowed
- `subscribers` (INTEGER) - Number of subscribers

### 3. New `billing_history` table
- `id` (SERIAL PRIMARY KEY)
- `user_id` (INTEGER) - References users table
- `amount` (INTEGER) - Amount in cents
- `status` (VARCHAR) - Payment status
- `created_at` (TIMESTAMP) - When the record was created

## How to Apply These Fixes

### Option 1: Use Drizzle Migration (Recommended)
```bash
# The migration has already been generated
npm run db:migrate
```

### Option 2: Run the TypeScript Script
```bash
# Set your database URL first
export DATABASE_URL="postgresql://user:password@host:5432/dbname"

# Run the fix script
npx tsx scripts/run-database-fixes.ts
```

### Option 3: Run SQL Directly
```bash
# Using psql
psql $DATABASE_URL < scripts/fix-database-columns.sql
```

### Option 4: Use the Helper Script
```bash
# This will guide you through the process
./scripts/apply-database-fixes.sh
```

## Files Created

1. **Migration File**: `migrations/0014_yellow_green_goblin.sql`
   - Generated by Drizzle Kit
   - Contains all schema changes

2. **SQL Script**: `scripts/fix-database-columns.sql`
   - Raw SQL commands
   - Can be run directly in PostgreSQL

3. **TypeScript Script**: `scripts/run-database-fixes.ts`
   - Uses Drizzle ORM
   - Includes verification steps

4. **Helper Script**: `scripts/apply-database-fixes.sh`
   - Interactive bash script
   - Guides you through the options

## Important Notes

- These changes are backward compatible
- They add default values so existing data won't break
- The `billing_history` table is new and won't affect existing data
- Always backup your database before running migrations in production

## Production Deployment

For production:
```bash
# 1. Backup your database first!
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. Apply the migration
npm run db:migrate

# 3. Verify the changes
psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name = 'reddit_post_outcomes' AND column_name IN ('success', 'title', 'upvotes', 'views');"
```
